---
title: 'Comparing betas between runwise and subj-wise (DMCC2 batch) GLMs'
author: "michael freund"
date: "15 April 2020"
output:
  html_document:
  toc: true
highlight: zenburn
---
  
```{r setup, include = FALSE}

knitr::opts_chunk$set(
  cache = TRUE, echo = FALSE, warning = FALSE, message = FALSE,
  fig.align = 'center',
  fig.width = 11.5, fig.fullwidth = TRUE
)

set.seed(0)

library(here)
library(magrittr)
library(dplyr)
library(data.table)
library(mikeutils)
library(lme4)
library(ggplot2)
library(ggbeeswarm)
library(grid)
library(gridExtra)
library(cowplot)
library(cifti)
library(gifti)
library(abind)

## settings ----

theme_set(theme_classic(base_size = 8))

## data ----

pretrial <- fread(here("data", "pretrial_behavior.csv"))  ## behavior and events
pretrial.subjsum <- fread(here("data", "pretrial_subjsumm.csv"))  ## summary of behavior and events / subj

## paths ----

dir.ccp.hcp <- "/data/nil-bluearc/ccp-hcp/DMCC_ALL_BACKUPS/HCP_SUBJECTS_BACKUPS/AFNI_ANALYSIS"
dir.subsubj <- file.path("/data/nil-external/ccp/freund/sub-subj-glms/runwise_old")

subjs <- intersect(
  list.dirs(dir.subsubj, recursive = FALSE, full.names = FALSE),
  list.dirs(dir.ccp.hcp, recursive = FALSE, full.names = FALSE)
)

sessi <- c("baseline", "proactive")
sessi.short <- c("Bas", "Pro")
glms <- "Congruency_EVENTS_censored"
n.knots <- 6
regressors <- c("PC50InCon", "biasInCon", "PC50Con", "biasCon")
networks <- c("Vis", "DorsAttn", "SalVentAttn", "Cont", "Default", "SomMot", "Limbic")

## refine list of subjects

## read this guy in just to get the subjs for which we presently have stats:
means.2tr1knot <- abind(
  readRDS(here("out", "rsa", "means_shaefer400_baseline_Congruency_EVENTS_censored.rds")),
  readRDS(here("out", "rsa", "means_shaefer400_proactive_Congruency_EVENTS_censored.rds")),
  rev.along = 0
)
names(dimnames(means.2tr1knot)) <- c("param", "run", "knot", "parcel", "subj", "session")
has.stats <- apply(means.2tr1knot, "subj", function(.) !any(is.na(c(.))))
rm(means.2tr1knot)

subjs.with.stats <- names(has.stats)[has.stats]
subjs.bad <- unique(pretrial.subjsum[subj.set == "bad"]$subj)
subjs.good.with.stats <- setdiff(subjs.with.stats, subjs.bad)


## atlases ----

# list.files("/data/nil-bluearc/ccp-hcp/DMCC_ALL_BACKUPS/ATLASES")

parcellation <- read_atlas("schaefer400")

nodename <- Sys.info()["nodename"]
if (nodename == "ccplinux1") {
  dir.atlas <- "/data/nil-external/ccp/freund/atlases"
  dir.schaefer <- "/data/nil-bluearc/ccp-hcp/DMCC_ALL_BACKUPS/ATLASES/"
} else if (nodename == "CCP-FREUND") {
  dir.atlas <- "C:/local/atlases"
  dir.schaefer <- dir.atlas
}


hcp <- list(
  L  = readGIfTI(
    file.path(dir.atlas, "surf", "HCP_S1200_GroupAvg_v1", "S1200.L.midthickness_MSMAll.32k_fs_LR.surf.gii")
  ),
  R = readGIfTI(
    file.path(dir.atlas, "surf", "HCP_S1200_GroupAvg_v1", "S1200.R.midthickness_MSMAll.32k_fs_LR.surf.gii")
  )
)

over <- list(
  L = parcellation$atlas[1:(nrow(parcellation$atlas) / 2)], 
  R = parcellation$atlas[(nrow(parcellation$atlas) / 2):nrow(parcellation$atlas)]
)

schaefer <- list(
  L = read_gifti2matrix(
    "/data/nil-bluearc/ccp-hcp/DMCC_ALL_BACKUPS/ATLASES/Schaefer2018_400Parcels_7Networks_order_L.label.gii"
    ) %>% c,
  R = read_gifti2matrix(
    "/data/nil-bluearc/ccp-hcp/DMCC_ALL_BACKUPS/ATLASES/Schaefer2018_400Parcels_7Networks_order_R.label.gii"
    ) %>% c
)

```


```{r}


n.iter <- length(sessi) * length(subjs) * length(glms)
pb <- progress_bar$new(
  format = " running [:bar] :percent eta: :eta (elapsed: :elapsed)",
  total = n.iter, clear = FALSE, width = 120
)

a <- array(
  NA,
  dim = c(
    param  = length(regressors),
    measu  = 2,
    knot   = n.knots,
    roi    = length(parcellation$key), 
    subj   = length(subjs),
    sess   = length(sessi)
  ),
  dimnames = list(
    param  = regressors,
    measu  = c("corr", "eucl"),
    knot   = paste0("knot", seq_len(n.knots)),
    roi    = parcellation$key, 
    subj   = subjs,
    sess   = sessi
    )
)


for (sess.i in seq_along(sessi)) {
  # sess.i = 1
  
  name.sess.i <- sessi[sess.i]

    for (subj.i in seq_along(subjs)) {
      ## subj.i = 1
      
      name.subj.i <- subjs[subj.i]
      
      ## read data ----
      
      ## build paths
      
      dir.subsubj.i <- file.path(
        dir.subsubj, name.subj.i, "RESULTS", "Stroop", name.sess.i, 
        paste0(name.sess.i, "_Congruency_EVENTS_censored")
      )
      dir.ccp.hcp.i <- file.path(
        dir.ccp.hcp, name.subj.i, "SURFACE_RESULTS", "Stroop", 
        paste0(name.sess.i, "_Congruency_EVENTS_censored")
      )
      
      f.betas.subsubj <- c(
        run1_R = file.path(paste0(dir.subsubj.i, "_run1"), paste0("betas_", subjs[subj.i], "_R.func.gii")),
        run1_L = file.path(paste0(dir.subsubj.i, "_run1"), paste0("betas_", subjs[subj.i], "_L.func.gii")),
        run2_R = file.path(paste0(dir.subsubj.i, "_run2"), paste0("betas_", subjs[subj.i], "_R.func.gii")),
        run2_L = file.path(paste0(dir.subsubj.i, "_run2"), paste0("betas_", subjs[subj.i], "_L.func.gii"))
      )
      
      f.betas.ccp.hcp <- c(
        R = file.path(dir.ccp.hcp.i, paste0("STATS_", subjs[subj.i], "_REML_R.func.gii")),
        L = file.path(dir.ccp.hcp.i, paste0("STATS_", subjs[subj.i], "_REML_L.func.gii"))
      )
      
      
      ## check existence
      
      file.is.missing <- any(!file.exists(f.betas.subsubj, f.betas.ccp.hcp))
      if (file.is.missing) next
      
      
      ## read into lists
      
      betas.subsubj.l <- vector("list", 4) %>% setNames(combo_paste(c("run1", "run2"), c("L", "R")))
      betas.ccp.hcp.l <- vector("list", 2) %>% setNames(c("L", "R"))
      
      for (name.hemi.i in c("L", "R")) {
        # name.hemi.i = "L"
        
        for (name.run.i in c("run1", "run2")) {
          # name.run.i = "run1"
          
          name.run.hemi.i <- paste0(name.run.i, "_", name.hemi.i)
          
          betas.subsubj.l[[name.run.hemi.i]] <- collate_surface_params(
            f.betas.subsubj[name.run.hemi.i], 
            pattern = paste0(regressors, c("#[0-9]"), collapse = "|")
          )
        
        }
        
        betas.ccp.hcp.l[[name.hemi.i]] <- collate_surface_params(
          f.betas.ccp.hcp[name.hemi.i], 
          pattern = paste0(regressors, c("#[0-9]_Coef"), collapse = "|")
          )
        
      }

      ## wrangle to same format
      
      betas.subsubj <- cbind(
        betas.subsubj.l[["run1_L"]] + betas.subsubj.l[["run2_L"]],
        betas.subsubj.l[["run1_R"]] + betas.subsubj.l[["run2_R"]]
      ) / 2  ## average across run
      
      betas.ccp.hcp <- cbind(betas.ccp.hcp.l[["L"]], betas.ccp.hcp.l[["R"]])
      
      are.matched <-
        identical(dim(betas.subsubj), dim(betas.ccp.hcp)) && 
        identical(dimnames(betas.subsubj), dimnames(betas.ccp.hcp))
      if (are.matched) stop("ccphcp and subsubj arrays not matched!")
      
      
      ## calculate similarities ----
      
      ## TODO
      
      for (parcel.i in parcellation$key) {
        
        for (knot.i in seq_len(n.knots[name.glm.i])) {
          # knot.i = 1
          
          
  
        }  ## knot loop end
          
      }  ## parcel loop end
        

        
  }  ## subj loop end

}  ## session loop end




```


---
title: 'Defining ROIs'
author: "michael freund"
date: "09 April 2020"
output:
  html_document:
  toc: true
highlight: zenburn
---
  
```{r setup, include = FALSE}

knitr::opts_chunk$set(
  cache = TRUE, echo = FALSE, warning = FALSE, message = FALSE,
  fig.align = 'center',
  fig.width = 11.5, fig.fullwidth = TRUE
)

set.seed(0)

library(here)
library(magrittr)
library(dplyr)
library(data.table)
library(mikeutils)
library(lme4)
library(ggplot2)
library(ggbeeswarm)
library(grid)
library(gridExtra)
library(cowplot)
library(cifti)
library(gifti)
library(abind)

## settings ----

theme_set(theme_classic(base_size = 8))


## data ----

## behavior and events

pretrial <- fread(here("data", "pretrial_behavior.csv"))
pretrial.subjsum <- fread(here("data", "pretrial_subjsumm.csv"))

## parcel-wise similarity matrices

## vanilla RSA

vanil.1tr1knot <- abind(
  abind(
    readRDS(here("out", "rsa", "rmatrix_vanilla_corr_shaefer400_baseline_Congruency_EVENTS_tentzero01210_censored.rds")),
    readRDS(here("out", "rsa", "rmatrix_vanilla_corr_shaefer400_proactive_Congruency_EVENTS_tentzero01210_censored.rds")),
    rev.along = 0
  ),
  -abind(
    readRDS(here("out", "rsa", "rmatrix_vanilla_eucl_shaefer400_baseline_Congruency_EVENTS_tentzero01210_censored.rds")),
    readRDS(here("out", "rsa", "rmatrix_vanilla_eucl_shaefer400_proactive_Congruency_EVENTS_tentzero01210_censored.rds")),
    rev.along = 0
  ),
  -abind(
    readRDS(here("out", "rsa", "rmatrix_vanilla_neuc_shaefer400_baseline_Congruency_EVENTS_tentzero01210_censored.rds")),
    readRDS(here("out", "rsa", "rmatrix_vanilla_neuc_shaefer400_proactive_Congruency_EVENTS_tentzero01210_censored.rds")),
    rev.along = 0
  ),
  rev.along = 0
)

names(dimnames(vanil.1tr1knot)) <- c(".row", ".col", "norma", "knot", "parcel", "subj", "session", "measure")
dimnames(vanil.1tr1knot)$session <- c("baseline", "proactive")
dimnames(vanil.1tr1knot)$measure <- c("corr", "neg.eucl", "neg.neuc")

cross.1tr1knot <- abind(
  abind(
    readRDS(here("out", "rsa", "rmatrix_crossva_corr_shaefer400_baseline_Congruency_EVENTS_tentzero01210_censored.rds")),
    # readRDS(here("out", "rsa", "rmatrix_crossva_corr_shaefer400_proactive_Congruency_EVENTS_tentzero01210_censored.rds")),
    rev.along = 0
  ),
  -abind(
    readRDS(here("out", "rsa", "rmatrix_crossva_eucl_shaefer400_baseline_Congruency_EVENTS_tentzero01210_censored.rds")),
    # readRDS(here("out", "rsa", "rmatrix_crossva_eucl_shaefer400_proactive_Congruency_EVENTS_tentzero01210_censored.rds")),
    rev.along = 0
  ),
  -abind(
    readRDS(here("out", "rsa", "rmatrix_crossva_neuc_shaefer400_baseline_Congruency_EVENTS_tentzero01210_censored.rds")),
    # readRDS(here("out", "rsa", "rmatrix_crossva_neuc_shaefer400_proactive_Congruency_EVENTS_tentzero01210_censored.rds")),
    rev.along = 0
  ),
  rev.along = 0
)

names(dimnames(cross.1tr1knot)) <- c(".row", ".col", "norma", "knot", "parcel", "subj", "session", "measure")
dimnames(cross.1tr1knot)$session <- c("baseline", "proactive")
dimnames(cross.1tr1knot)$measure <- c("corr", "neg.eucl", "neg.neuc")

## variables ----

networks <- c("Vis", "DorsAttn", "SalVentAttn", "Cont", "Default", "SomMot", "Limbic")

## get subj lists

subjs.analysis <- unique(pretrial.subjsum[subj.set == "analysis"]$subj)
subjs.development <- unique(pretrial.subjsum[subj.set == "development"]$subj)
subjs.bad <- unique(pretrial.subjsum[subj.set == "bad"]$subj)

## filter by those with data

has.stats <- apply(means.2tr1knot, "subj", function(.) !any(is.na(c(.))))
subjs.with.stats <- names(has.stats)[has.stats]

## TODO
## these subjects do not have stats
# setdiff(c(subjs.analysis, subjs.development), subjs.with.stats)
## could be due to
##  - no 3d+t gifti -> have RAs run
##  - no beta gifti -> diagnose problem and fit

subjs.analysis <- intersect(subjs.analysis, subjs.with.stats)
subjs.development <- intersect(subjs.development, subjs.with.stats)
subjs.bad <- intersect(subjs.bad, subjs.with.stats)

## subset data

means.2tr1knot <- means.2tr1knot[, ,  , , subjs.analysis, ]
means.1tr1knot <- means.1tr1knot[, ,  , , subjs.analysis, ]

vanil.2tr1knot <- vanil.2tr1knot[, , , , , subjs.analysis, , ]
vanil.1tr1knot <- vanil.1tr1knot[, , , , , subjs.analysis, , ]

## rsa models

dnames <- dimnames(vanil.2tr1knot)$.row
m <- diag(length(dnames))
dimnames(m) <- dimnames(vanil.2tr1knot)[c(".row", ".col")]
m[] <- 0
lt <- lower.tri(m)

is.incon <- grepl("InCon", dnames)
is.congr <- grepl("PC50Con|biasCon", dnames)
is.pc50  <- grepl("PC50", dnames)
is.bias  <- grepl("bias", dnames)
is.run1  <- grepl("run1", dnames)
is.run2  <- grepl("run2", dnames)

m.incon <- m
m.congr <- m
m.pc50 <- m
m.bias <- m
m.bias.any <- m
m.run <- m
m.ond <- m
m.offd <- m

m.incon[is.incon, is.incon] <- 1
m.congr[is.congr, is.congr] <- 1
m.pc50[is.pc50, is.pc50] <- 1
m.bias.any[is.bias, ] <- 1
m.bias.any[, is.bias] <- 1
m.bias[is.bias, is.bias] <- 1
m.run[is.run1, is.run1] <- 1
m.run[is.run2, is.run2] <- 1
diag(m.ond[is.run1, is.run2]) <- 1
diag(m.ond[is.run2, is.run1]) <- 1
m.offd <- 1 - m.ond
diag(m.offd) <- 0

mlist <- list(m.incon, m.congr, m.pc50, m.bias, m.bias.any, m.run, m.ond, m.offd)
names(mlist) <- c("incon", "congr", "pc50", "bias", "bias.any", "run", "ond", "offd")

rm(m.incon, m.congr, m.pc50, m.bias, m.bias.any, m.run, m.ond, m.offd)


## atlases ----

# list.files("/data/nil-bluearc/ccp-hcp/DMCC_ALL_BACKUPS/ATLASES")

parcellation <- read_atlas("schaefer400")

nodename <- Sys.info()["nodename"]
if (nodename == "ccplinux1") {
  dir.atlas <- "/data/nil-external/ccp/freund/atlases"
  dir.schaefer <- "/data/nil-bluearc/ccp-hcp/DMCC_ALL_BACKUPS/ATLASES/"
} else if (nodename == "CCP-FREUND") {
  dir.atlas <- "C:/local/atlases"
  dir.schaefer <- dir.atlas
}


hcp <- list(
  L  = readGIfTI(
    file.path(dir.atlas, "surf", "HCP_S1200_GroupAvg_v1", "S1200.L.midthickness_MSMAll.32k_fs_LR.surf.gii")
  ),
  R = readGIfTI(
    file.path(dir.atlas, "surf", "HCP_S1200_GroupAvg_v1", "S1200.R.midthickness_MSMAll.32k_fs_LR.surf.gii")
  )
)

over <- list(
  L = parcellation$atlas[1:(nrow(parcellation$atlas) / 2)], 
  R = parcellation$atlas[(nrow(parcellation$atlas) / 2):nrow(parcellation$atlas)]
)

# schaefer <- list(
#   L = read_gifti2matrix(
#     "/data/nil-bluearc/ccp-hcp/DMCC_ALL_BACKUPS/ATLASES/Schaefer2018_400Parcels_7Networks_order_L.label.gii"
#     ) %>% c,
#   R = read_gifti2matrix(
#     "/data/nil-bluearc/ccp-hcp/DMCC_ALL_BACKUPS/ATLASES/Schaefer2018_400Parcels_7Networks_order_R.label.gii"
#     ) %>% c
# )

```

# About

# Univariate

## Stats


```{r means_stats_prep}

## to data.frames

means.2tr1knot.d <- reshape2::melt(means.2tr1knot, value.name = "m") %>% mutate(glm = "2tr1knot")
means.1tr1knot.d <- reshape2::melt(means.1tr1knot, value.name = "m") %>% mutate(glm = "1tr1knot")

means.2tr1knot.d$tr <- as.numeric(gsub("knot", "", means.2tr1knot.d$knot)) * 2  ## knots to TRs
means.1tr1knot.d$tr <- as.numeric(gsub("knot", "", means.1tr1knot.d$knot))
means.d <- rbind(means.2tr1knot.d, means.1tr1knot.d)  ## bind different glms

means.d$network <- ""  ## add networks
for (network.i in networks) means.d$network[grepl(network.i, means.d$parcel)] <- network.i

# means.d$seconds <- means.d$tr * 1.2

means.d$trial.type <- gsub("PC50|bias", "", means.d$param)
means.d$pc <- gsub("InCon|Con", "", means.d$param)

means.d$run <- factor(means.d$run, levels = c("run1", "run2"))
means.d$trial.type <- factor(means.d$trial.type, levels = c("Con", "InCon"))
means.d$pc <- factor(means.d$pc, levels = c("PC50", "bias"))
means.d$session <- factor(means.d$session, levels = c("baseline", "proactive"))

```


```{r means_stats, echo = TRUE}

## marginal curves: average across regressors per session*run

means.d.marginal <- means.d %>%
  group_by(run, parcel, session, glm, network, tr, subj) %>%
  summarize(m = mean(m)) %>%  ## average across trial types
  summarize(s = sd(m), m = mean(m))  ## average across subjects


## main effects models

# means.d.1tr1knot <- means.d %>% filter(glm == "1tr1knot")  ## consider only 1-tr-per-knot glm

means.l.me <- means.d %>% split(paste(.$tr, .$parcel, .$session, .$network, .$glm, sep = "."))
mods.means.me <- lapply(means.l.me, function(x) lm(m ~ run + pc + trial.type, x))  ## fit
coef.means.me <- lapply(mods.means.me, broom::tidy)  ## extract
coef.means.me %<>%  ## format
  bind_rows(.id = "model.id") %>%
  cbind(reshape2::colsplit(.$model.id, "\\.", c("tr", "parcel", "session", "network", "glm")))
coef.means.me %<>%  ## adjust
  group_by(tr, session) %>%
  mutate(p.fdr = p.adjust(p.value, "fdr"))

## interaction models (PC50 only)

means.l.x <- means.d[means.d$pc == "PC50", ] %>% 
  split(paste(.$tr, .$parcel, .$network, .$glm, sep = "."))
mods.means.x <- lapply(means.l.x, function(x) lm(m ~ run + session * trial.type, x))  ## fit
coef.means.x <- lapply(mods.means.x, broom::tidy)  ## extract
coef.means.x %<>%  ## format
  bind_rows(.id = "model.id") %>%
  cbind(reshape2::colsplit(.$model.id, "\\.", c("tr", "parcel", "network", "glm")))
coef.means.x %<>%  ## adjust
  group_by(tr) %>%
  mutate(p.fdr = p.adjust(p.value, "fdr"))

```


## Marginal impulse responses (averaged across all event types)

Curves plot parcel-wise average beta, across all subjects and event / trial types.

```{r means_plot_marginal, fig.height = 6, fig.width = 15}

## marginal

p.marginal.1tr1knot <- means.d.marginal %>%
  filter(glm == "1tr1knot") %>%
  mutate(session.run = paste0(session, " ", run)) %>%
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session.run)) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(type = "qual", palette = 1) +
  scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  scale_y_continuous(limits = c(-1, 3)) +
  labs(title = "1 TR / knot", x = "TR (post stimulus onset)", y = "beta") +
  theme(legend.position = "none")

p.marginal.2tr1knot <- means.d.marginal %>%
  filter(glm == "2tr1knot") %>%
  group_by(tr, run, parcel, session, network, glm) %>% summarize(m = mean(m)) %>% ## average across subjs
  mutate(session.run = paste0(session, " ", run)) %>%
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session.run)) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(type = "qual", palette = 1) +
  scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  scale_y_continuous(limits = c(-1, 3)) +
  labs(title = "2 TR / knot", x = "TR (post stimulus onset)", y = "beta") +
  theme(legend.position = "none")

grid.arrange(
  p.marginal.1tr1knot, p.marginal.2tr1knot, 
  top = "parcel-wise mean activation (across all event estimates)",
  ncol = 2
)


```

Seems like plenty of signal in the 1 TR per knot GLMs.

Now to checking the variability across subjects.
These curves plot parcel-wise standard deviations of marginal impulse responses (across subjects).
```{r means_plot_marginal_sd, fig.height = 6, fig.width = 15}

## marginal

p.marginal.1tr1knot.sd <- means.d.marginal %>%
  filter(glm == "1tr1knot") %>%
  mutate(session.run = paste0(session, " ", run)) %>%
  ggplot(aes(tr, s)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session.run)) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(type = "qual", palette = 1) +
  scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  scale_y_continuous(limits = c(0, 3)) +
  labs(title = "1 TR / knot", x = "TR (post stimulus onset)", y = "sd(beta)") +
  theme(legend.position = "none")

p.marginal.2tr1knot.sd <- means.d.marginal %>%
  filter(glm == "2tr1knot") %>%
  mutate(session.run = paste0(session, " ", run)) %>%
  ggplot(aes(tr, s)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session.run)) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(type = "qual", palette = 1) +
  scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  scale_y_continuous(limits = c(0, 3)) +
  labs(title = "2 TR / knot", x = "TR (post stimulus onset)", y = "sd(beta)") +
  theme(legend.position = "none")

grid.arrange(
  p.marginal.1tr1knot.sd, p.marginal.2tr1knot.sd, 
  top = "parcel-wise standard deviation in activation (across subjects)",
  ncol = 2
)


```



## Contrasts: main effects of run, pc, and trial.type

A linear model was fit on each parcel\*session\*knot, with dummy-coded regresssors for **run**, **proportion congruence**, (pc50, bias) and **trial type** (congruent, incongruent).

Curves plot parcel-wise t statistic for each regressor.

Here only 1 TR / knot GLMs are considered.

```{r means_plot_maineffects, fig.height = 6, fig.width = 15}

## run

coef.means.me %>%
  filter(term == "runrun2", glm == "1tr1knot") %>%
  ggplot(aes(tr, statistic)) +
  geom_beeswarm(
    aes(fill = network, alpha = p.fdr < 0.05, color = ifelse(p.fdr < 0.05, "black", "white")), 
    size = 1.5, shape = 21
  ) +
  scale_color_identity() +
  scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.2)) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  scale_fill_brewer(type = "qual", palette = 1) +
  scale_x_continuous(limits = c(0, 9), breaks = seq(1, 8)) +
  labs(title = "run effect (run 2 minus run 1)", x = "TR (post stimulus onset)", y = "t statistic") +
  theme(legend.position = "none")

## pc

coef.means.me %>%
  filter(term == "pcbias", glm == "1tr1knot") %>%
  ggplot(aes(tr, statistic)) +
  geom_beeswarm(
    aes(fill = network, alpha = p.fdr < 0.05, color = ifelse(p.fdr < 0.05, "black", "white")), 
    size = 1.5, shape = 21
  ) +
  scale_color_identity() +
  scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.2)) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  scale_fill_brewer(type = "qual", palette = 1) +
  scale_x_continuous(limits = c(0, 9), breaks = seq(1, 8)) +
  labs(title = "pc effect (bias minus pc50)", x = "TR (post stimulus onset)", y = "t statistic") +
  theme(legend.position = "none")

## stroop

coef.means.me %>%
  filter(term == "trial.typeInCon", glm == "1tr1knot") %>%
  ggplot(aes(tr, statistic)) +
  geom_beeswarm(
    aes(fill = network, alpha = p.fdr < 0.05, color = ifelse(p.fdr < 0.05, "black", "white")), 
    size = 1.5, shape = 21
  ) +
  scale_color_identity() +
  scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.2)) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  scale_fill_brewer(type = "qual", palette = 1) +
  scale_x_continuous(limits = c(0, 9), breaks = seq(1, 8)) +
  labs(title = "stroop effect", x = "TR (post stimulus onset)", y = "t statistic") +
  theme(legend.position = "none")

## stroop, just to check 2tr1knot:

coef.means.me %>%
  filter(term == "trial.typeInCon", glm == "2tr1knot") %>%
  ggplot(aes(tr, statistic)) +
  geom_beeswarm(
    aes(fill = network, alpha = p.fdr < 0.05, color = ifelse(p.fdr < 0.05, "black", "white")), 
    size = 1.5, shape = 21
  ) +
  scale_color_identity() +
  scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.2)) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  scale_fill_brewer(type = "qual", palette = 1) +
  labs(title = "stroop effect: 2tr1knot", x = "TR (post stimulus onset)", y = "t statistic") +
  theme(legend.position = "none")


```

Stroop effect positive across control networks during 'target' TRs (2--5).
Stroop effect negative across most parcels, networks at TR 8 (final timepoint estimated).


Now to examine the impulse responses as a function of trial type.

```{r means_plot_percond, fig.height = 6, fig.width = 15}

means.d.percond <- means.d %>%
  group_by(parcel, session, glm, network, tr, param) %>%
  summarize(m = mean(m))

means.d.percond %>%
  filter(glm == "1tr1knot", session == "baseline") %>%
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(param)) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(type = "qual", palette = 1) +
  labs(title = "baseline, 1 TR / knot", x = "TR (post stimulus onset)", y = "mean(beta)") +
  theme(legend.position = "none")

means.d.percond %>%
  filter(glm == "1tr1knot", session == "proactive") %>%
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(param)) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(type = "qual", palette = 1) +
  labs(title = "proactive, 1 TR / knot", x = "TR (post stimulus onset)", y = "mean(beta)") +
  theme(legend.position = "none")

means.d.percond %>%
  filter(glm == "2tr1knot", session == "baseline") %>%
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(param)) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(type = "qual", palette = 1) +
  labs(title = "baseline, 2 TR / knot", x = "TR (post stimulus onset)", y = "mean(beta)") +
  theme(legend.position = "none")

means.d.percond %>%
  filter(glm == "2tr1knot", session == "proactive") %>%
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(param)) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(type = "qual", palette = 1) +
  labs(title = "proactive, 2 TR / knot", x = "TR (post stimulus onset)", y = "mean(beta)") +
  theme(legend.position = "none")


means.d %>%
  filter(glm == "1tr1knot", tr == 8) %>%
  mutate(trial.type = gsub("PC50|bias", "", param)) %>%
  group_by(parcel, session, glm, network, tr, trial.type) %>%
  summarize(m = mean(m)) %>%
  tidyr::pivot_wider(names_from = "trial.type", values_from = "m") %>%
  ggplot(aes(Con, InCon)) +
  geom_point(aes(color = network), size = 1) +
  facet_grid(vars(session), vars(network)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  scale_color_brewer(type = "qual", palette = 1) +
  labs(title = "1 TR / knot") +
  theme(legend.position = "none")

means.d %>%
  filter(glm == "2tr1knot", tr == 8) %>%
  mutate(trial.type = gsub("PC50|bias", "", param)) %>%
  group_by(parcel, session, glm, network, tr, trial.type) %>%
  summarize(m = mean(m)) %>%
  tidyr::pivot_wider(names_from = "trial.type", values_from = "m") %>%
  ggplot(aes(Con, InCon)) +
  geom_point(aes(color = network), size = 1) +
  facet_grid(vars(session), vars(network)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  scale_color_brewer(type = "qual", palette = 1) +
  labs(title = "2 TR / knot") +
  theme(legend.position = "none")

```
Deactivation at final TRs estimated (e.g., TR = 8), across sessions and trial types.
However, more deactivation in baseline incongruent versus congruent.

## Contrasts: interaction of trial.type with session for PC50 items

Filled in circles now indicate p(uncorrected) < 0.05. (No parcels were significant with FDR correction.)
```{r means_plot_interaction, fig.height = 6, fig.width = 15}

## stroop

coef.means.x %>%
  filter(term == "sessionproactive:trial.typeInCon", glm == "1tr1knot") %>%
  ggplot(aes(tr, statistic)) +
  geom_beeswarm(
    aes(fill = network, alpha = p.value < 0.05, color = ifelse(p.value < 0.05, "black", "white")), 
    size = 1.5, shape = 21
  ) +
  scale_color_identity() +
  scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.2)) +
  facet_grid(vars(network)) +
  geom_hline(yintercept = 0) +
  scale_fill_brewer(type = "qual", palette = 1) +
  scale_x_continuous(limits = c(0, 9), breaks = seq(1, 8)) +
  labs(title = "PC50 stroop effect by session (proactive - baseline)", x = "TR (post stimulus onset)", y = "t statistic") +
  theme(legend.position = "none")

```

## List

```{r, echo = TRUE}

roi.univ.bas <- coef.means.me %>%
  filter(term == "trial.typeInCon", p.fdr < 0.05, session == "baseline", tr >= 2, tr <= 5, estimate > 0) %>%
  pull(parcel) %>% 
  unique

roi.univ.bas


roi.univ.pro <- coef.means.me %>%
  filter(term == "trial.typeInCon", p.fdr < 0.05, session == "proactive", tr >= 2, tr <= 5, estimate > 0) %>%
  pull(parcel) %>% 
  unique

roi.univ.pro

roi.univ.pro.uncorrected <- coef.means.me %>%
  filter(term == "trial.typeInCon", p.value < 0.05, session == "proactive", tr >= 2, tr <= 5, estimate > 0) %>%
  pull(parcel) %>% 
  unique

roi.univ.pro.uncorrected


```



# Multivariate: 'vanilla' RSA

* cross-run RSA
* models: on-diag (reliability), on-vs-off diag (omnibus encoding), incongruency (incon - baseline)
* focus incongruency analysis on PC50 items only: trial counts balanced between congruent and incongruent trial types.


## Stats


```{r vanil_stats_prep}

## unwrap lower-triangle of similarity matrices to vector

vanil.1tr1knot.lt <- apply(
  vanil.1tr1knot, 
  c("norma", "knot", "parcel", "subj", "session", "measure"), 
  function(x) x[lt]
)  ## unwrap to lower triangle

vanil.2tr1knot.lt <- apply(
  vanil.2tr1knot, 
  c("norma", "knot", "parcel", "subj", "session", "measure"), 
  function(x) x[lt]
)  ## unwrap to lower triangle

## fisher transform correlations

vanil.1tr1knot.lt[, , , , , , "corr"] <- atanh(vanil.1tr1knot.lt[, , , , , , "corr"])  ## r to z
vanil.2tr1knot.lt[, , , , , , "corr"] <- atanh(vanil.2tr1knot.lt[, , , , , , "corr"])  ## r to z

## build design matrices

params.omnibus <- c("ond", "offd", "run")
params.inconub <- c("incon", "congr", "bias.any", "run")

X.omnibus <- cbind(intercept = 1, vapply(mlist[params.omnibus], function(x) x[lt], numeric(sum(lt))))  ## include intercept
X.inconub <- cbind(intercept = 1, vapply(mlist[params.inconub], function(x) x[lt], numeric(sum(lt))))

# qcor(mlist$ond)
# qcor(mlist$offd)

```



```{r vanil_stats, echo = TRUE}

## 'omnibus' models ----

vanil.1tr1knot.subj.omnibus <- apply(
  vanil.1tr1knot.lt, 
  c("norma", "knot", "parcel", "subj", "session", "measure"),
  function(y) .lm.fit(X.omnibus, y)$coef
)  ## fit
dimnames(vanil.1tr1knot.subj.omnibus)[[1]] <- colnames(X.omnibus)
names(dimnames(vanil.1tr1knot.subj.omnibus))[[1]] <- "param"

vanil.2tr1knot.subj.omnibus <- apply(
  vanil.2tr1knot.lt, 
  c("norma", "knot", "parcel", "subj", "session", "measure"),
  function(y) .lm.fit(X.omnibus, y)$coef
)  ## fit
dimnames(vanil.2tr1knot.subj.omnibus)[[1]] <- colnames(X.omnibus)
names(dimnames(vanil.2tr1knot.subj.omnibus))[[1]] <- "param"

vanil.omnibus <- rbind(
  reshape2::melt(vanil.2tr1knot.subj.omnibus) %>% mutate(glm = "2tr1knot", tr = as.numeric(gsub("knot", "", knot)) * 2),
  reshape2::melt(vanil.1tr1knot.subj.omnibus) %>% mutate(glm = "1tr1knot", tr = as.numeric(gsub("knot", "", knot)))
)

vanil.omnibus$network <- ""  ## add networks
for (network.i in networks) vanil.omnibus$network[grepl(network.i, vanil.omnibus$parcel)] <- network.i


## "incongruency unbiased" (pc50) models ----

vanil.1tr1knot.subj.inconub <- apply(
  vanil.1tr1knot.lt, 
  c("norma", "knot", "parcel", "subj", "session", "measure"),
  function(y) .lm.fit(X.inconub, y)$coef
)  ## fit
dimnames(vanil.1tr1knot.subj.inconub)[[1]] <- colnames(X.inconub)
names(dimnames(vanil.1tr1knot.subj.inconub))[[1]] <- "param"

vanil.2tr1knot.subj.inconub <- apply(
  vanil.2tr1knot.lt, 
  c("norma", "knot", "parcel", "subj", "session", "measure"),
  function(y) .lm.fit(X.inconub, y)$coef
)  ## fit
dimnames(vanil.2tr1knot.subj.inconub)[[1]] <- colnames(X.inconub)
names(dimnames(vanil.2tr1knot.subj.inconub))[[1]] <- "param"

vanil.inconub <- rbind(
  reshape2::melt(vanil.2tr1knot.subj.inconub) %>% mutate(glm = "2tr1knot", tr = as.numeric(gsub("knot", "", knot)) * 2),
  reshape2::melt(vanil.2tr1knot.subj.inconub) %>% mutate(glm = "1tr1knot", tr = as.numeric(gsub("knot", "", knot)))
)

vanil.inconub$network <- ""  ## add networks
for (network.i in networks) vanil.inconub$network[grepl(network.i, vanil.inconub$parcel)] <- network.i


## group-level stats ----

vanil.omnibus.group <- vanil.omnibus %>%
  filter(param %in% c("ond", "offd")) %>%
  tidyr::spread(param, value) %>%
  mutate(diff = ond - offd, offd = NULL) %>%
  tidyr::pivot_longer(c("ond", "diff"), names_to = "param", values_to = "value") %>%
  group_by(norma, tr, parcel, session, measure, glm, param, network) %>%
  summarize(
    p = wilcox.test(value, alternative = "greater")$p.value,
    w = wilcox.test(value, alternative = "greater")$statistic,
    m = mean(value)
  ) %>%
  group_by(norma, tr, session, measure, glm, param, network) %>%
  mutate(p.fdr = p.adjust(p, method = "fdr"))

vanil.me.group <-  vanil.inconub %>% 
  # filter(param == "incon") %>%
  group_by(norma, tr, parcel, session, measure, glm, network, param) %>%
  summarize(
    p = wilcox.test(value, alternative = "greater")$p.value,
    w = wilcox.test(value, alternative = "greater")$statistic,
    m = mean(value)
  ) %>%
  group_by(norma, tr, session, measure, glm, network, param) %>%
  mutate(p.fdr = p.adjust(p, method = "fdr"))

vanil.x.group <- vanil.inconub %>%
  filter(param == "incon") %>%
  tidyr::spread(session, value) %>%
  # tidyr::pivot_wider(names_from = session, values_from = "value") %>%
  mutate(value = proactive - baseline) %>%
  group_by(norma, tr, parcel, measure, glm, network) %>%
  summarize(
    p = wilcox.test(value)$p.value,
    w = wilcox.test(value)$statistic,
    m = mean(value)
  ) %>%
  group_by(norma, tr, measure, glm, network) %>%
  mutate(p.fdr = p.adjust(p, method = "fdr"))

```

## Omnibus: reliability and an 'encoding test'

These curves are across all items (bias + pc50)

```{r vanil_plot_omnibus, fig.height = 6, fig.width = 15}

## omnibus

vanil.omnibus.group %>%
  
  filter(glm == "1tr1knot", measure == "corr", norma == "raw", param == "ond") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-1, 3)) +
  
  labs(title = "mean cross-run reliability", x = "TR (post stimulus onset)", y = "z") +
  theme(legend.position = "none")

vanil.omnibus.group %>%
  
  filter(glm == "1tr1knot", measure == "corr", norma == "raw", param == "diff") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-1, 3)) +
  
  labs(title = "mean reliability - mean off-diagonal", x = "TR (post stimulus onset)", y = "z") +
  theme(legend.position = "none")

```


## Incongruency contrast per session (PC50 items only)

```{r vanil_plot_incongruency, fig.height = 6, fig.width = 15}

## incongruency

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "corr", param == "incon", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: correlation", 
    x = "TR (post stimulus onset)",
    y = "sim(incon, incon) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "corr", param == "incon", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened correlation", 
    x = "TR (post stimulus onset)", 
    y = "sim(incon, incon) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.eucl", param == "incon", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: neg. euclidean",
    x = "TR (post stimulus onset)", 
    y = "sim(incon, incon) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.eucl", param == "incon", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened neg. euclidean", 
    x = "TR (post stimulus onset)",
    y = "sim(incon, incon) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.neuc", param == "incon", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: neg. normalized euclidean",
    x = "TR (post stimulus onset)", 
    y = "sim(incon, incon) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.neuc", param == "incon", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened neg. normalized euclidean", 
    x = "TR (post stimulus onset)",
    y = "sim(incon, incon) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


```


## Congruency contrast per session (PC50 items only)

```{r vanil_plot_congruency, fig.height = 6, fig.width = 15}

## congruency

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "corr", param == "congr", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: correlation", 
    x = "TR (post stimulus onset)",
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "corr", param == "congr", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened correlation", 
    x = "TR (post stimulus onset)", 
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.eucl", param == "congr", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: neg. euclidean",
    x = "TR (post stimulus onset)", 
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.eucl", param == "congr", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened neg. euclidean", 
    x = "TR (post stimulus onset)",
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.neuc", param == "congr", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: neg. normalized euclidean",
    x = "TR (post stimulus onset)", 
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.neuc", param == "congr", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened neg. normalized euclidean", 
    x = "TR (post stimulus onset)",
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


```


## Incongruent--congruent similarity per session (PC50 items only)

```{r vanil_plot_intercept, fig.height = 6, fig.width = 15}

## congruency

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "corr", param == "intercept", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: correlation", 
    x = "TR (post stimulus onset)",
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "corr", param == "intercept", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened correlation", 
    x = "TR (post stimulus onset)", 
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.eucl", param == "intercept", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: neg. euclidean",
    x = "TR (post stimulus onset)", 
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.eucl", param == "intercept", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened neg. euclidean", 
    x = "TR (post stimulus onset)",
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.neuc", param == "intercept", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: neg. normalized euclidean",
    x = "TR (post stimulus onset)", 
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.neuc", param == "intercept", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened neg. normalized euclidean", 
    x = "TR (post stimulus onset)",
    y = "sim(congr, congr) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


```


## Run contrast per session (PC50 items only)

```{r vanil_plot_run, fig.height = 6, fig.width = 15}

## congruency

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "corr", param == "intercept", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: correlation", 
    x = "TR (post stimulus onset)",
    y = "sim(within-run) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "corr", param == "intercept", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened correlation", 
    x = "TR (post stimulus onset)", 
    y = "sim(within-run) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.eucl", param == "intercept", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: neg. euclidean",
    x = "TR (post stimulus onset)", 
    y = "sim(within-run) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.eucl", param == "intercept", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened neg. euclidean", 
    x = "TR (post stimulus onset)",
    y = "sim(within-run) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.neuc", param == "intercept", norma == "raw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: neg. normalized euclidean",
    x = "TR (post stimulus onset)", 
    y = "sim(within-run) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")

vanil.me.group %>%
  
  filter(glm == "1tr1knot", measure == "neg.neuc", param == "intercept", norma == "prw") %>%
  
  ggplot(aes(tr, m)) +
  geom_line(aes(group = parcel, color = network), size = 1) +
  facet_grid(vars(network), vars(session)) +
  geom_hline(yintercept = 0) +
  
  scale_color_brewer(type = "qual", palette = 1) +
  # scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
  # scale_y_continuous(limits = c(-0.5, 0.2)) +
  
  labs(
    title = "simil measure: prewhitened neg. normalized euclidean", 
    x = "TR (post stimulus onset)",
    y = "sim(within-run) - sim(incon, congr)"
  ) +
  theme(legend.position = "none")


```


## List

```{r, echo = TRUE}

roi.multiv.bas <- vanil.me.group %>%
  filter(glm == "1tr1knot", param == "incon", p.fdr < 0.05, session == "baseline", tr >= 2, tr <= 5, norma == "raw") %>%
  pull(parcel) %>% 
  unique %>%
  as.character

roi.multiv.bas
# roi.univ.bas

roi.multiv.bas.prw <- vanil.me.group %>%
  filter(glm == "1tr1knot", param == "incon", p.fdr < 0.05, session == "baseline", tr >= 2, tr <= 5, norma == "prw") %>%
  pull(parcel) %>% 
  unique %>%
  as.character

roi.multiv.bas.prw


roi.multiv.pro <- vanil.me.group %>%
  filter(glm == "1tr1knot", param == "incon", p.fdr < 0.05, session == "proactive", tr >= 2, tr <= 5) %>%
  pull(parcel) %>% 
  unique %>%
  as.character

roi.multiv.pro
# roi.univ.pro

```


# lower reliabilities on congruent pc50 proactive vs baseline?
# other canonical effects to look for in proactive glm?


```{r }


rois <- intersect(roi.multiv.bas, roi.univ.bas)
setdiff(roi.multiv.bas, roi.univ.bas)
setdiff(roi.univ.bas, roi.multiv.bas)
setdiff(parcellation$key, c(roi.multiv.bas, roi.univ.bas))


r <- apply(
  atanh(vanil.1tr1knot[, , "raw", "knot8", 1, , "proactive", "corr"]),
  c(".row", ".col"),
  mean
) %>%
  tanh
r <- r[is.run1, is.run2]
# r <- r[, is.run2]
qcor(r, cl.lim = c(-0.1, 0.1))
# corrplot::corrplot(r, method = "number")
r



vanil.inconub %>%
  filter(parcel == rois[1], glm == "1tr1knot", measure == "corr", param == "incon") %>%
  ggplot(aes(as.factor(tr), value, fill = norma)) +
  # geom_violin(width = 0.1, position = position_dodge(width = 0.15)) +
  geom_boxplot(width = 0.1, position = position_dodge(width = 0.15)) +
  # geom_beeswarm() +
  facet_grid(cols = vars(session))

# filter(param == "incon") %>%
group_by(norma, tr, parcel, session, measure, glm, network, param) %>%
  summarize(
    p = wilcox.test(value, alternative = "greater")$p.value,
    w = wilcox.test(value, alternative = "greater")$statistic,
    m = mean(value)
  ) %>%
  group_by(norma, tr, session, measure, glm, network, param) %>%
  mutate(p.fdr = p.adjust(p, method = "fdr"))


# ## all cross-run correlations, all within pc50 items:
# ##   - congruent--incongruent correlation (intercept) is approximately equal across sessions
# ##   - incongruent--incongruent correlaion is positive and higher across the board in proactive versus baseline
# ##   - congruent--congruent correlation is negative and lower across the board in proactive verus baseline
# 
# ## something is wrong with the proactive session results.
# ##  - model fitting procedure?
# ##  - RDMs?
# ##  - GLMs?
# ##  ...
# 
# 
# 
# 
# 
# 
# 
# 
# 
# vanil.me.group %>%
#   filter(glm == "2tr1knot", measure == "corr", norma == "raw", param == "incon", session == "proactive", p.fdr < 0.05)
# 
# 
# vanil.me.group %>%
#   filter(p.fdr < 0.05)
# 
# apply(vanil.1tr1knot[, , "raw", , , , "baseline", "corr"], c(".row", ".col"), mean) %>% qcor
# apply(vanil.1tr1knot[, , "raw", , , , "proactive", "corr"], c(".row", ".col"), mean) %>% qcor
# 
# p <- apply(vanil.1tr1knot[, , "raw", , , , "proactive", "corr"], c(".row", ".col"), mean)
# p <- p[is.pc50, ]
# p <- p[, is.pc50]
# qcor(p)
# 
# b <- apply(vanil.1tr1knot[, , "raw", , , , "baseline", "corr"], c(".row", ".col"), mean)
# b <- b[is.pc50, ]
# b <- b[, is.pc50]
# qcor(b)
# 
# 
# b1 <- apply(vanil.1tr1knot[, , "raw", , , 1, "baseline", "corr"], c(".row", ".col"), mean)
# qcor(b1)
# 
# names(dimnames(vanil.1tr1knot))
# 
# 
# qcor(mlist$run)
# qcor(mlist$bias.any)
# 
# qcor((1 - mlist$bias.any) * (1 - mlist$run) * mlist$incon *  (1 - mlist$congr))
# 
# qcor((1 - mlist$bias.any) * (1 - mlist$run) * (1 - mlist$incon) *  (1 - mlist$congr))
# 
# 
# 
# 
# 
# 
# 
# 
# vanil.x.group %>%
#   
#   filter(glm == "1tr1knot", measure == "corr") %>%
#   
#   ggplot(aes(tr, p)) +
#   geom_line(aes(group = parcel, color = network), size = 1) +
#   facet_grid(vars(network), vars(norma)) +
#   geom_hline(yintercept = 0) +
#   
#   scale_color_brewer(type = "qual", palette = 1)
#   scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
#   scale_y_continuous(limits = c(-1, 3)) +
#   
#   labs(title = "1 TR / knot", x = "TR (post stimulus onset)", y = "beta") +
#   theme(legend.position = "none")
#   
# 
#   
#   
#   
# vanil.omnibus.group %>%
#   
#   filter(glm == "2tr1knot") %>%
#   
#   mutate(session.run = paste0(session, " ", run)) %>%
#   
#   ggplot(aes(tr, m)) +
#   geom_line(aes(group = parcel, color = network), size = 1) +
#   facet_grid(vars(network), vars(session.run)) +
#   geom_hline(yintercept = 0) +
#   
#   scale_color_brewer(type = "qual", palette = 1)
#   scale_x_continuous(limits = c(1, 12), breaks = seq(1, 12)) +
#   scale_y_continuous(limits = c(-1, 3)) +
#   
#   labs(title = "2 TR / knot", x = "TR (post stimulus onset)", y = "beta") +
#   theme(legend.position = "none")
# 
# 
# grid.arrange(
#   p.marginal.1tr1knot, p.marginal.2tr1knot, 
#   top = "parcel-wise mean activation (across all event estimates)",
#   ncol = 2
#   )
# 

```
